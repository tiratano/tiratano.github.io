<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" xmlns="">
<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body onload="init()">

<div>
    <div>
        <h1>일별 확진자수 / 양성률 / 볼린저 밴드</h1>
    </div>
    <svg id="chart1"></svg>
</div>

<div>
    <div>
        <h1>연령대별 확진자 수 / 양성률</h1>
    </div>
    <svg id="chart2"></svg>
</div>

<div>
    <div>
        <h1>백신 접종자 수</h1>
    </div>
    <svg id="chart2"></svg>
</div>

<script>
async function init() {
    // Source: COVID-19 (coronavirus) by Our World in Data
    // https://github.com/owid/covid-19-data/tree/master/public/data
    const data = await d3.csv('./covid_kor_all.csv');

    var width = 900;
    var height = 200;
    var margin = 50;

    var state_date = data.map((v) => { return v['date']; })
    var new_cases = data.map((x) => { let v = x['new_cases']; if (v == "") return 0; return Number.parseInt(v); })
    max_val = new_cases.reduce((a, b) => Math.max(a, b), 0);

    var parseTime = d3.timeParse("%Y-%m-%d");
    var dates = [];
    for (let obj of data) {
        dates.push(parseTime(obj.date));
    }
    var domain = d3.extent(dates); // date: from ~ to
    domain[1] = parseTime('2021-08-01'); // set end date to 2021-08-01
    var xScale = d3.scaleTime().domain(domain).range([0, width]);
    var xAxis = d3.axisBottom(xScale);

    var x = d3.scaleBand().domain(Array.from(Array(dates.length).keys())).range([0, width]);
    var y = d3.scaleLinear().domain([0, max_val]).range([height, 0]);
    var ys = d3.scaleLinear().domain([0, 1]).range([0, height/max_val]);
    var vis = d3.select("#chart1")
        .attr("width", width + 2 * margin)
        .attr("height", height + 2 * margin);

    vis.append("g")
        .attr("transform", "translate(" + margin + "," + margin + ")")
        .selectAll("rect").data(data)
        .enter().append("rect")
        .attr("x", function (d, i) {
            return x(i);
        })
        .attr("y", function (d) {
            return y(d.new_cases);
        })
        .attr("width", 1)
        .attr("height", function (d) {
            return ys(d.new_cases);
        })
        .style("fill", "steelblue");

    // y axis
    d3.select("#chart1")
        .append("g")
        .attr("transform", "translate(" + margin + "," + margin + ")")
        .call(d3.axisLeft(y));

    // x axis
    d3.select("#chart1")
        .append("g")
        .attr("class", "xaxis")
        .attr("transform", "translate(" + margin + "," + (height + margin) + ")")
        .call(
            xAxis.ticks(d3.timeMonth)
                .tickFormat(d3.timeFormat("%Y-%m-%d"))
        );

    // x axix > rotate 45 degrees
    vis.selectAll(".xaxis text")
        .attr("transform", function(d) {
            return "translate(" + this.getBBox().height*-2 + "," + this.getBBox().height + ")rotate(-45)";
        });

}
</script>

</body>
</html>
