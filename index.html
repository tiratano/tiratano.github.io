<!DOCTYPE html>
<meta charset="utf-8" xmlns="">
<html>
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .x.axis path {
            display: none;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
    </style>
</head>

<body onload="init()">

<div>
    <h1>
        COVID19 Correlation Analysis
    </h1>
    <div>
        <pre>
    Nowadays, there are tremendous news about COVID19,
    but mostly of them just say here is a number of confirmed new cases.
    Even though, no matter the reason is, people should be careful for the COVID19 prevention,
    Sometimes one might be curious about the reason or the correlation about the several variables.

    For example, if Delta variants has the strong correlation with the new cases,
    one might can be examine the characters of the Delta variants.

    Correlation does not simply imply causation but it help provides a hint.
    Let's find correlation of integrated Covid19 Information.

    Each parts has differenct characters, so I split it up for the drop down.
        </pre>
    </div>
</div>
<svg id="chart_new_cases"></svg>
<svg id="chart_new_tests"></svg>
<svg id="chart_new_deaths"></svg>
<svg id="chart_new_people_vaccinated"></svg>
<svg id="chart_new_age_0-9_conf_case"></svg>

<script>
async function init() {
    // Source: COVID-19 (coronavirus) by Our World in Data
    // https://github.com/owid/covid-19-data/tree/master/public/data
    const data = await d3.csv('./covid_kor_all.csv');

    var top_margin = 0;
    var margin = 50;
    var width = 600;
    var height = 100;

    function drawChart(column_name, chart_id, has_x_axis, chart_title) {
        var state_date = data.map((v) => { return v['date']; })
        var new_cases = data.map((x) => { let v = x[column_name]; if (v == "") return 0; return Number.parseInt(v); })
        var max_val = new_cases.reduce((a, b) => Math.max(a, b), 0);
        console.log(column_name + "'s max value: " + max_val);

        var parseTime = d3.timeParse("%Y-%m-%d");
        var dates = [];
        for (let obj of data) {
            dates.push(parseTime(obj.date));
        }
        var domain = d3.extent(dates); // date: from ~ to
        domain[1] = parseTime('2021-08-01'); // set end date to 2021-08-01
        var xScale = d3.scaleTime().domain(domain).range([0, width]);
        var xAxis = d3.axisBottom(xScale);

        var x = d3.scaleBand().domain(Array.from(Array(dates.length).keys())).range([0, width]);
        var x_invert = d3.scaleBand().domain(Array.from(Array(dates.length).keys())).range([width, 0]);

        var y = d3.scaleLinear().domain([0, max_val]).range([height, 0]);
        var y_invert = d3.scaleLinear().domain([0, max_val]).range([0, height]);

        var ys = d3.scaleLinear().domain([0, 1]).range([0, height/max_val]);
        var vis = d3.select(chart_id)
            .attr("width", width + 2 * margin)
            .attr("height", height + top_margin + margin);

        vis.append("g")
            .attr("transform", "translate(" + margin + "," + top_margin + ")")
            .selectAll("rect").data(data)
            .enter().append("rect")
            .attr("x", function (d, i) {
                return x(i);
            })
            .attr("y", function (d) {
                return y(d[column_name]);
            })
            .attr("width", 1)
            .attr("height", function (d) {
                return ys(d[column_name]);
            })
            .style("fill", "steelblue");

        // label
        d3.select(chart_id)
            .selectAll("text")
            .data(d => [""])
            .join("text")
            .text(chart_title)
            .attr("x", margin + 10)
            .attr("y", 10)
            .attr("font-weight", "bold")
        ;

        // y axis
        d3.select(chart_id)
            .append("g")
            .attr("transform", "translate(" + margin + "," + top_margin + ")")
            .call(d3.axisLeft(y));

        // x axis
        if (has_x_axis) {
            d3.select(chart_id)
                .append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(" + margin + "," + (height + top_margin) + ")")
                .call(
                    xAxis.ticks(d3.timeMonth)
                        .tickFormat(d3.timeFormat("%Y-%m-%d"))
                );

            // x axix > rotate 45 degrees
            vis.selectAll(".xaxis text")
                .attr("transform", function (d) {
                    return "translate(" + this.getBBox().height * -2 + "," + this.getBBox().height + ")rotate(-45)";
                });
        } else {
            d3.select(chart_id)
                .append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(" + margin + "," + (height + top_margin) + ")")
                .call(
                    xAxis.tickSize([0,0])
                        .tickFormat(d3.timeFormat(""))
                );
        }

        return vis;
    }
 
    var vis = drawChart('new_cases', '#chart_new_cases', true, 'new_cases');
    var vis = drawChart('new_tests', '#chart_new_tests', true, 'new_tests');
    var vis = drawChart('new_deaths', '#chart_new_deaths', true, 'new_deaths');
    var vis = drawChart('new_people_vaccinated', '#chart_new_people_vaccinated', true, 'new_people_vaccinated');
    var vis = drawChart('new_age_0-9_conf_case', '#chart_new_age_0-9_conf_case', false, 'new_age_0-9_conf_case');

    //////////////////////////////////////////////////
    // mouse actions
    //////////////////////////////////////////////////
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    var mouseG = vis.append("g")
        .attr("class", "mouse-over-effects");

    mouseG.append("path") // this is the black vertical line to follow mouse
        .attr("class", "mouse-line")
        .style("stroke", "black")
        .style("stroke-width", "1px")
        .style("opacity", "0");

    mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
        .attr("transform", "translate(" + margin + "," + top_margin + ")") // 마우스 캡쳐할 영역도 margin 고려해야 함.
        .attr('width', width) // can't catch mouse events on a g element
        .attr('height', height)
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .on('mouseout', function() { // on mouse out hide line, circles and text
            d3.select(".mouse-line")
                .style("opacity", "0");
            d3.selectAll(".mouse-per-line circle")
                .style("opacity", "0");
            d3.selectAll(".mouse-per-line text")
                .style("opacity", "0");
        })
        .on('mouseover', function() { // on mouse in show line, circles and text
            d3.select(".mouse-line")
                .style("opacity", "1");
            d3.selectAll(".mouse-per-line circle")
                .style("opacity", "1");
            d3.selectAll(".mouse-per-line text")
                .style("opacity", "1");
        })
        .on('mousemove', function(event) { // mouse moving over canvas
            var mouse = d3.pointer(event);
            d3.select(".mouse-line")
                .attr("d", function() {
                    var d = "M" + (mouse[0] + margin) + "," + height;
                    d += " " + (mouse[0] + margin) + "," + 0;
                    return d;
                });
        });
}
</script>

</body>
</html>
